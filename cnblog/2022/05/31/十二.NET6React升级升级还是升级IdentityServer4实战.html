<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>ï¼ˆåäºŒï¼‰.NET6 + React ï¼šå‡çº§ï¼å‡çº§ï¼è¿˜æ˜¯***å‡çº§ï¼ï¼ï¼+ IdentityServer4å®æˆ˜ | dotnetä¹‹ç¾</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="ï¼ˆåäºŒï¼‰.NET6 + React ï¼šå‡çº§ï¼å‡çº§ï¼è¿˜æ˜¯***å‡çº§ï¼ï¼ï¼+ IdentityServer4å®æˆ˜" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="ä¸€ã€å‰è¨€# æ­¤ç¯‡å†…å®¹è¾ƒå¤šï¼Œæˆ‘æ˜¯ä¸€æ­¥ä¸€ä¸ªè„šå°(å‘)ï¼Œä»¥è‡³äºå†™äº†å¥½ä¹…ï¼Œä¸»è¦æ˜¯è¿™å‡ éƒ¨åˆ†ï¼šåå°å‡çº§ .NET6Â Â VS2022ã€å‰å°å‡çº§Ant Design Pro V5 ã€å‰åå°è”è°ƒ IdentityServer4 å®æˆ˜ï¼Œä»¥åŠå„éƒ¨åˆ†åœ¨Linuxç¯å¢ƒä¸‹éƒ¨ç½²ç­‰ç­‰ã€‚ äºŒã€åå°å‡çº§.NET6# WebApiå’Œç±»åº“éƒ½å‡çº§åˆ°.NET6ï¼Œä¾èµ–åŒ…éƒ½å‡çº§åˆ°6.0ä»¥ä¸Šæœ€æ–°ï¼Œå¥½åƒæ²¡ä»€ä¹ˆæ„ŸçŸ¥ï¼Œç•¥æ„Ÿeasyã€‚ï¼ˆé™„ä¸€å¼ å†™å®Œåæœ€æ–°çš„é¡¹ç›®ç»“æ„å›¾ï¼‰ https://img2022.cnblogs.com/blog/1780813/202204/1780813-20220422101400332-1039947071.pnghttps://img2022.cnblogs.com/blog/1780813/202204/1780813-20220422100156239-58634689.pnghttps://img2022.cnblogs.com/blog/1780813/202205/1780813-20220530121416228-147030239.png ä¸‰ã€IdentityServer4å®æˆ˜# 1ã€ç”¨æˆ·ç®¡ç†# è¿˜å¥½ä¸Šç¯‡æŒä¹…åŒ–å·²ç»åšäº†90%çš„å·¥ä½œï¼Œä¸è¿‡æ˜¯åœ¨Demoé‡Œé¢ï¼Œç°åœ¨æ¬åˆ°ä¸»é¡¹ç›®é‡Œæ¥ï¼Œç”¨æˆ·éƒ¨åˆ†ã€å®¢æˆ·ç«¯é…ç½®éƒ¨åˆ†æ ¹æ®å®é™…æƒ…å†µç¨åŠ æ”¹åŠ¨ã€‚" />
<meta property="og:description" content="ä¸€ã€å‰è¨€# æ­¤ç¯‡å†…å®¹è¾ƒå¤šï¼Œæˆ‘æ˜¯ä¸€æ­¥ä¸€ä¸ªè„šå°(å‘)ï¼Œä»¥è‡³äºå†™äº†å¥½ä¹…ï¼Œä¸»è¦æ˜¯è¿™å‡ éƒ¨åˆ†ï¼šåå°å‡çº§ .NET6Â Â VS2022ã€å‰å°å‡çº§Ant Design Pro V5 ã€å‰åå°è”è°ƒ IdentityServer4 å®æˆ˜ï¼Œä»¥åŠå„éƒ¨åˆ†åœ¨Linuxç¯å¢ƒä¸‹éƒ¨ç½²ç­‰ç­‰ã€‚ äºŒã€åå°å‡çº§.NET6# WebApiå’Œç±»åº“éƒ½å‡çº§åˆ°.NET6ï¼Œä¾èµ–åŒ…éƒ½å‡çº§åˆ°6.0ä»¥ä¸Šæœ€æ–°ï¼Œå¥½åƒæ²¡ä»€ä¹ˆæ„ŸçŸ¥ï¼Œç•¥æ„Ÿeasyã€‚ï¼ˆé™„ä¸€å¼ å†™å®Œåæœ€æ–°çš„é¡¹ç›®ç»“æ„å›¾ï¼‰ https://img2022.cnblogs.com/blog/1780813/202204/1780813-20220422101400332-1039947071.pnghttps://img2022.cnblogs.com/blog/1780813/202204/1780813-20220422100156239-58634689.pnghttps://img2022.cnblogs.com/blog/1780813/202205/1780813-20220530121416228-147030239.png ä¸‰ã€IdentityServer4å®æˆ˜# 1ã€ç”¨æˆ·ç®¡ç†# è¿˜å¥½ä¸Šç¯‡æŒä¹…åŒ–å·²ç»åšäº†90%çš„å·¥ä½œï¼Œä¸è¿‡æ˜¯åœ¨Demoé‡Œé¢ï¼Œç°åœ¨æ¬åˆ°ä¸»é¡¹ç›®é‡Œæ¥ï¼Œç”¨æˆ·éƒ¨åˆ†ã€å®¢æˆ·ç«¯é…ç½®éƒ¨åˆ†æ ¹æ®å®é™…æƒ…å†µç¨åŠ æ”¹åŠ¨ã€‚" />
<link rel="canonical" href="/cnblog/2022/05/31/%E5%8D%81%E4%BA%8C.NET6React%E5%8D%87%E7%BA%A7%E5%8D%87%E7%BA%A7%E8%BF%98%E6%98%AF%E5%8D%87%E7%BA%A7IdentityServer4%E5%AE%9E%E6%88%98.html" />
<meta property="og:url" content="/cnblog/2022/05/31/%E5%8D%81%E4%BA%8C.NET6React%E5%8D%87%E7%BA%A7%E5%8D%87%E7%BA%A7%E8%BF%98%E6%98%AF%E5%8D%87%E7%BA%A7IdentityServer4%E5%AE%9E%E6%88%98.html" />
<meta property="og:site_name" content="dotnetä¹‹ç¾" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-05-31T08:40:52+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="ï¼ˆåäºŒï¼‰.NET6 + React ï¼šå‡çº§ï¼å‡çº§ï¼è¿˜æ˜¯***å‡çº§ï¼ï¼ï¼+ IdentityServer4å®æˆ˜" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-05-31T08:40:52+00:00","datePublished":"2022-05-31T08:40:52+00:00","description":"ä¸€ã€å‰è¨€# æ­¤ç¯‡å†…å®¹è¾ƒå¤šï¼Œæˆ‘æ˜¯ä¸€æ­¥ä¸€ä¸ªè„šå°(å‘)ï¼Œä»¥è‡³äºå†™äº†å¥½ä¹…ï¼Œä¸»è¦æ˜¯è¿™å‡ éƒ¨åˆ†ï¼šåå°å‡çº§ .NET6Â Â VS2022ã€å‰å°å‡çº§Ant Design Pro V5 ã€å‰åå°è”è°ƒ IdentityServer4 å®æˆ˜ï¼Œä»¥åŠå„éƒ¨åˆ†åœ¨Linuxç¯å¢ƒä¸‹éƒ¨ç½²ç­‰ç­‰ã€‚ äºŒã€åå°å‡çº§.NET6# WebApiå’Œç±»åº“éƒ½å‡çº§åˆ°.NET6ï¼Œä¾èµ–åŒ…éƒ½å‡çº§åˆ°6.0ä»¥ä¸Šæœ€æ–°ï¼Œå¥½åƒæ²¡ä»€ä¹ˆæ„ŸçŸ¥ï¼Œç•¥æ„Ÿeasyã€‚ï¼ˆé™„ä¸€å¼ å†™å®Œåæœ€æ–°çš„é¡¹ç›®ç»“æ„å›¾ï¼‰ https://img2022.cnblogs.com/blog/1780813/202204/1780813-20220422101400332-1039947071.pnghttps://img2022.cnblogs.com/blog/1780813/202204/1780813-20220422100156239-58634689.pnghttps://img2022.cnblogs.com/blog/1780813/202205/1780813-20220530121416228-147030239.png ä¸‰ã€IdentityServer4å®æˆ˜# 1ã€ç”¨æˆ·ç®¡ç†# è¿˜å¥½ä¸Šç¯‡æŒä¹…åŒ–å·²ç»åšäº†90%çš„å·¥ä½œï¼Œä¸è¿‡æ˜¯åœ¨Demoé‡Œé¢ï¼Œç°åœ¨æ¬åˆ°ä¸»é¡¹ç›®é‡Œæ¥ï¼Œç”¨æˆ·éƒ¨åˆ†ã€å®¢æˆ·ç«¯é…ç½®éƒ¨åˆ†æ ¹æ®å®é™…æƒ…å†µç¨åŠ æ”¹åŠ¨ã€‚","headline":"ï¼ˆåäºŒï¼‰.NET6 + React ï¼šå‡çº§ï¼å‡çº§ï¼è¿˜æ˜¯***å‡çº§ï¼ï¼ï¼+ IdentityServer4å®æˆ˜","mainEntityOfPage":{"@type":"WebPage","@id":"/cnblog/2022/05/31/%E5%8D%81%E4%BA%8C.NET6React%E5%8D%87%E7%BA%A7%E5%8D%87%E7%BA%A7%E8%BF%98%E6%98%AF%E5%8D%87%E7%BA%A7IdentityServer4%E5%AE%9E%E6%88%98.html"},"url":"/cnblog/2022/05/31/%E5%8D%81%E4%BA%8C.NET6React%E5%8D%87%E7%BA%A7%E5%8D%87%E7%BA%A7%E8%BF%98%E6%98%AF%E5%8D%87%E7%BA%A7IdentityServer4%E5%AE%9E%E6%88%98.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="dotnetä¹‹ç¾" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">dotnetä¹‹ç¾</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">ï¼ˆåäºŒï¼‰.NET6 + React ï¼šå‡çº§ï¼å‡çº§ï¼è¿˜æ˜¯***å‡çº§ï¼ï¼ï¼+ IdentityServer4å®æˆ˜</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2022-05-31T08:40:52+00:00" itemprop="datePublished">May 31, 2022
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="ä¸€å‰è¨€">ä¸€ã€å‰è¨€#</h2>

<p><strong>æ­¤ç¯‡å†…å®¹è¾ƒå¤šï¼Œæˆ‘æ˜¯ä¸€æ­¥ä¸€ä¸ªè„šå°(å‘)ï¼Œä»¥è‡³äºå†™äº†å¥½ä¹…ï¼Œä¸»è¦æ˜¯è¿™å‡ éƒ¨åˆ†ï¼šåå°å‡çº§ <a href="https://dotnet.microsoft.com/zh-cn/download">.NET6</a>Â Â <a href="https://visualstudio.microsoft.com/zh-hans/downloads/">VS2022</a>ã€å‰å°å‡çº§<a href="https://pro.ant.design/zh-CN/">Ant Design Pro V5</a> ã€å‰åå°è”è°ƒ IdentityServer4 å®æˆ˜ï¼Œä»¥åŠå„éƒ¨åˆ†åœ¨Linuxç¯å¢ƒä¸‹éƒ¨ç½²ç­‰ç­‰ã€‚</strong></p>

<h2 id="äºŒåå°å‡çº§net6">äºŒã€åå°å‡çº§.NET6#</h2>

<p><strong>WebApiå’Œç±»åº“éƒ½å‡çº§åˆ°.NET6ï¼Œä¾èµ–åŒ…éƒ½å‡çº§åˆ°6.0ä»¥ä¸Šæœ€æ–°ï¼Œå¥½åƒæ²¡ä»€ä¹ˆæ„ŸçŸ¥ï¼Œç•¥æ„Ÿeasyã€‚ï¼ˆé™„ä¸€å¼ å†™å®Œåæœ€æ–°çš„é¡¹ç›®ç»“æ„å›¾ï¼‰</strong><br />
 https://img2022.cnblogs.com/blog/1780813/202204/1780813-20220422101400332-1039947071.pnghttps://img2022.cnblogs.com/blog/1780813/202204/1780813-20220422100156239-58634689.pnghttps://img2022.cnblogs.com/blog/1780813/202205/1780813-20220530121416228-147030239.png</p>

<h2 id="ä¸‰identityserver4å®æˆ˜">ä¸‰ã€IdentityServer4å®æˆ˜#</h2>

<h4 id="1ç”¨æˆ·ç®¡ç†">1ã€ç”¨æˆ·ç®¡ç†#</h4>

<p><strong>è¿˜å¥½<a href="https://www.cnblogs.com/WinterSir/p/16087298.html">ä¸Šç¯‡æŒä¹…åŒ–</a>å·²ç»åšäº†90%çš„å·¥ä½œï¼Œä¸è¿‡æ˜¯åœ¨<a href="https://github.com/WinterSir/IdentityServer4.GrantTypesDemo">Demo</a>é‡Œé¢ï¼Œç°åœ¨æ¬åˆ°ä¸»é¡¹ç›®é‡Œæ¥ï¼Œç”¨æˆ·éƒ¨åˆ†ã€å®¢æˆ·ç«¯é…ç½®éƒ¨åˆ†æ ¹æ®å®é™…æƒ…å†µç¨åŠ æ”¹åŠ¨ã€‚</strong></p>

<blockquote>
  <p>è¿™é‡Œéœ€è¦è§£é‡Šä¸€ä¸‹ï¼Œç”¨æˆ·ã€è§’è‰²ç®¡ç†è¿™å—å¯ä»¥ç”¨Identityè¿›è¡Œç®¡ç†ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸šåŠ¡ç³»ç»Ÿé‡Œç®¡ç†ï¼Œid4åªåšç™»å½•é‰´æƒï¼Œè¿™é‡Œåªæ˜¯ä¸¾ä¸ªä¾‹å­ï¼ŒApplicationUserç»§æ‰¿IdentityUserï¼Œå®šä¹‰å­—æ®µUserInfoIdå…³è”UserInfoè¡¨ï¼Œå…·ä½“éœ€æ±‚æ ¹æ®é¡¹ç›®å®é™…æƒ…å†µæ¥è®¾è®¡ã€‚</p>
</blockquote>

<p>https://img2022.cnblogs.com/blog/1780813/202204/1780813-20220423135935026-1500801190.pnghttps://img2022.cnblogs.com/blog/1780813/202205/1780813-20220528164047845-1795345249.pnghttps://img2022.cnblogs.com/blog/1780813/202204/1780813-20220423162459503-1228161340.png</p>

<h4 id="2é…ç½®ä¿®æ”¹">2ã€é…ç½®ä¿®æ”¹#</h4>

<p><strong>ç®€åŒ–ã€æˆæƒç æ˜¯ç»™Reactå‰ç«¯ç”¨çš„ï¼Œæ··åˆæ¨¡å¼ç»™ Mvc å®¢æˆ·ç«¯ç”¨çš„ï¼ˆä¸€ä¸ªç©º.NET6 Mvcé¡¹ç›®ï¼Œä¹Ÿæ¬åˆ°ä¸»é¡¹ç›®äº†ï¼Œå…·ä½“çš„å¯ä»¥çœ‹ä»£ç ï¼‰</strong><br />
 https://img2022.cnblogs.com/blog/1780813/202205/1780813-20220528211459000-1170320134.png</p>

<h4 id="3æ•°æ®è¿ç§»">3ã€æ•°æ®è¿ç§»#</h4>

<p><strong>ä¾æ¬¡åœ¨ç¨‹åºåŒ…ç®¡ç†å™¨æ§åˆ¶å°è¾“å…¥è¿ç§»å‘½ä»¤ï¼Œå…¶ä»–è¡¨ç»“æ„æ•°æ®ç›¸åŒå°±ä¸è´´äº†ï¼Œ<a href="https://www.cnblogs.com/WinterSir/p/16087298.html">ä¸Šç¯‡æŒä¹…åŒ–</a>è¿‡ç¨‹éƒ½æœ‰è¯¦ç»†æ­¥éª¤å’Œç»“æœã€‚</strong><br />
 https://img2022.cnblogs.com/blog/1780813/202205/1780813-20220528164605841-112275738.png</p>

<h2 id="å››å‰å°å‡çº§-ant-design-pro-v5">å››ã€å‰å°å‡çº§ Ant Design Pro V5#</h2>

<p><strong>å‰å°å‡çº§ Ant Design Pro V5ï¼Œ<a href="https://www.cnblogs.com/WinterSir/p/13979030.html">ä¹‹å‰</a>ç”¨çš„æ˜¯V5é¢„è§ˆç‰ˆï¼Œå·²ç»æ˜¯ä¸€å¹´å‰çš„äº‹æƒ…äº†ã€‚ã€‚ã€‚æˆ‘åæ€ã€‚ã€‚ã€‚ğŸ˜…</strong></p>

<h4 id="1å®‰è£…ç»„ä»¶-oidc-client">1ã€å®‰è£…ç»„ä»¶ oidc-client#</h4>

<p><strong>cnpm install <a href="https://github.com/IdentityModel/oidc-client-js">oidc-client</a> â€“saveï¼Œæ–°å»ºè®¤è¯æœåŠ¡ç±» auth.ts ï¼Œè·Ÿåå° IdentityServer4 è®¤è¯æœåŠ¡é…åˆä½¿ç”¨ã€‚</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import { Log, User, UserManager } from 'oidc-client';

export class AuthService {
    public userManager: UserManager;
    constructor() {
        // const clientRoot = 'http://localhost:8000/';
        const clientRoot = 'https://homejok.wintersir.com/';        
        const settings = {
            authority: 'https://login.wintersir.com',
            //client_id: 'antdview',
            //response_type: 'id_token token',
            client_id: 'antdviewcode',
            client_secret: 'antdviewcode',
            response_type: 'code',
            redirect_uri: `${clientRoot}callback`,
            post_logout_redirect_uri: `${clientRoot}`,
            // silent_redirect_uri: `${clientRoot}silent-renew.html`,
            scope: 'openid profile HomeJokScope'
        };
        this.userManager = new UserManager(settings);

        Log.logger = console;
        Log.level = Log.WARN;
    }

    public login(): Promise&lt;void&gt; {
        //è®°å½•è·³è½¬ç™»å½•å‰çš„è·¯ç”±
        return this.userManager.signinRedirect({ state: window.location.href });
    }

    public signinRedirectCallback(): Promise&lt;User&gt; {
        return this.userManager.signinRedirectCallback();
    }

    public logout(): Promise&lt;void&gt; {
        return this.userManager.signoutRedirect();
    }

    public getUser(): Promise&lt;User | null&gt; {
        return this.userManager.getUser();
    }

    public renewToken(): Promise&lt;User&gt; {
        return this.userManager.signinSilent();
    }
}
</code></pre></div></div>

<h4 id="2ç™»å½•è®¤è¯è®¾ç½®">2ã€ç™»å½•è®¤è¯è®¾ç½®#</h4>

<p><strong>ä¿®æ”¹app.tsxï¼Œåˆå§‹åŒ–è®¤è¯æœåŠ¡ç±»ï¼Œåˆ¤æ–­ç™»å½•çŠ¶æ€ï¼Œè®¾ç½®è¯·æ±‚åå°æ‹¦æˆªå™¨ï¼Œæ·»åŠ  headers å’Œ token</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import type { Settings as LayoutSettings } from '@ant-design/pro-layout';
import { PageLoading } from '@/components/PageLoading';
import type { RequestConfig, RunTimeLayoutConfig } from 'umi';
import { history, Link } from 'umi';
import RightContent from '@/components/RightContent';
import { BookOutlined, LinkOutlined } from '@ant-design/icons';
import { AuthService } from '@/utils/auth';

const isDev = process.env.NODE_ENV === 'development';

const authService: AuthService = new AuthService();

/** è·å–ç”¨æˆ·ä¿¡æ¯æ¯”è¾ƒæ…¢çš„æ—¶å€™ä¼šå±•ç¤ºä¸€ä¸ª loading */
export const initialStateConfig = {
    loading: &lt;PageLoading /&gt;
};

/**
 * @see  https://umijs.org/zh-CN/plugins/plugin-initial-state
 * */
export async function getInitialState(): Promise&lt;{
    settings?: Partial&lt;LayoutSettings&gt;;
}&gt; {
    const init = localStorage.getItem('init');
    const token = localStorage.getItem('token');
    const user = localStorage.getItem('user');
    if (!token &amp;&amp; !init &amp;&amp; !user) {
        localStorage.setItem('init', 'true');
        authService.login();
    }
    return {
        settings: {}
    };
}

// ProLayout æ”¯æŒçš„api https://procomponents.ant.design/components/layout
export const layout: RunTimeLayoutConfig = ({ initialState }) =&gt; {
    const token = localStorage.getItem('token');
    const user = localStorage.getItem('user');
    return {
        rightContentRender: () =&gt; &lt;RightContent /&gt;,
        disableContentMargin: false,
        waterMarkProps: {
            //content: initialState?.currentUser?.name,
        },
        // footerRender: () =&gt; &lt;Footer /&gt;,
        onPageChange: () =&gt; {
            const { location } = history;
            if (!token &amp;&amp; !user &amp;&amp; location.pathname != "/callback") {
                authService.login();
            }
        },
        links: isDev
            ? [
                &lt;Link to="/umi/plugin/openapi" target="_blank"&gt;
                    &lt;LinkOutlined /&gt;
                    &lt;span&gt;OpenAPI æ–‡æ¡£&lt;/span&gt;
                &lt;/Link&gt;,
                &lt;Link to="/~docs"&gt;
                    &lt;BookOutlined /&gt;
                    &lt;span&gt;ä¸šåŠ¡ç»„ä»¶æ–‡æ¡£&lt;/span&gt;
                &lt;/Link&gt;,
            ]
            : [],
        menuHeaderRender: undefined,
        // è‡ªå®šä¹‰ 403 é¡µé¢
        // unAccessible: &lt;div&gt;unAccessible&lt;/div&gt;,
        ...initialState?.settings,
        //é˜²æ­¢æœªç™»å½•é—ªå±èœå•é—®é¢˜
        pure: token ? false : true 
    }
};

const authHeaderInterceptor = (url: string, options: RequestOptionsInit) =&gt; {
    const token = localStorage.getItem('token');
    const authHeader = { Accept: 'application/json', 'Content-Type': 'application/json', Authorization: 'Bearer ' + token };
    return {
        url: `${url}`,
        options: { ...options, interceptors: true, headers: authHeader },
    };
};
export const request: RequestConfig = {
    //timeout: 10000,
    // æ–°å¢è‡ªåŠ¨æ·»åŠ AccessTokençš„è¯·æ±‚å‰æ‹¦æˆªå™¨
    requestInterceptors: [authHeaderInterceptor],
};
</code></pre></div></div>

<h4 id="3ç™»å½•å›è°ƒè·å–ç”¨æˆ·ç™»å‡º">3ã€ç™»å½•å›è°ƒã€è·å–ç”¨æˆ·ã€ç™»å‡º#</h4>

<p><strong>ï¼ˆ1ï¼‰æ·»åŠ callback.tsxï¼Œè¿™æ˜¯ç™»å½•æˆåŠŸçš„å›è°ƒåœ°å€ï¼Œä¿å­˜ç™»å½•çŠ¶æ€tokenã€userç­‰ï¼Œè·³è½¬é¡µé¢ã€‚</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import { message, Result, Spin } from 'antd';
import React, { useEffect, useRef, useState } from 'react';
import { AuthService } from '@/utils/auth';
import { useRequest } from 'umi';
import { login } from '@/services/accountService';

const authService: AuthService = new AuthService();

const callback: React.FC = () =&gt; {
    const [msg, setMsg] = useState('ç©å‘½ç™»å½•ä¸­......');
    const authRedirect = useRef("/");
    const { run, loading } = useRequest(login, {
        manual: true,
        onSuccess: (result, params) =&gt; {
            if (result &amp;&amp; result.responseData) {
                localStorage.setItem('user', JSON.stringify(result.responseData));
                window.location.href = authRedirect.current;
            } else {
                setMsg('ç™»å½•å¤±è´¥ï¼Œå³å°†è·³è½¬é‡æ–°ç™»å½•......');
                setTimeout(() =&gt; {
                    localStorage.removeItem('init');
                    localStorage.removeItem('token');
                    window.location.href = authRedirect.current;
                }, 3000);
            }
        },
        onError: (error) =&gt; {
            message.error(error.message);
        }
    });
    useEffect(() =&gt; {
        authService.signinRedirectCallback().then(auth =&gt; {
            authRedirect.current = auth.state;
            localStorage.setItem('token', auth.access_token);
            run({ account: auth.profile.sub });
        })
    }, [])

    return (
        &lt;&gt;
            &lt;Result status="success" title={&lt;Spin spinning={loading} tip={msg}&gt;&lt;/Spin&gt;} /&gt;
        &lt;/&gt;
    )
};

export default callback;
</code></pre></div></div>

<p><strong>ï¼ˆ2ï¼‰accountService.tsx <a href="https://umijs.org/zh-CN">Umi</a>çš„useRequestã€Request é…åˆä½¿ç”¨</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import { request } from 'umi';
export async function login(payload: { account: string }, options?: { [key: string]: any }) {
    return request('/api/Account/Login', {
        method: 'POST',
        params: payload,
        ...(options || {}),
    });
}
</code></pre></div></div>

<p><strong>AvatarDropdown.tsx ç™»å‡ºæ ¸å¿ƒæ–¹æ³•</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const onMenuClick = useCallback(
  (event: MenuInfo) =&gt; {
    const { key } = event;
    if (key === 'logout') {
      localStorage.removeItem('init');
      localStorage.removeItem('user');
      localStorage.removeItem('token');
      authService.logout();
      return;
    }
    history.push(`/account/${key}`);
  },
  [],
);
</code></pre></div></div>

<h4 id="4è‡ªå®šä¹‰å…¶ä»–é…ç½®">4ã€è‡ªå®šä¹‰å…¶ä»–é…ç½®#</h4>

<p><strong>å¦‚ï¼šPageLoading ç­‰å¾…æ¡†ç»„ä»¶ã€defaultSettings.ts é¢œè‰²ã€å›¾æ ‡ç­‰é…ç½®é¡¹ã€routes.ts è·¯ç”±ï¼Œè¯¦ç»†è§ä»£ç ã€‚</strong></p>

<h2 id="äº”linuxæœåŠ¡å™¨éƒ¨ç½²">äº”ã€LinuxæœåŠ¡å™¨éƒ¨ç½²#</h2>

<h4 id="1net6-ç¯å¢ƒ">1ã€.NET6 ç¯å¢ƒ#</h4>

<p><strong>å‘1æœ‰CentOS7å®‰è£….NET6çš„æ­¥éª¤ï¼Œå…¶ä»–linuxç‰ˆæœ¬<a href="https://docs.microsoft.com/zh-cn/dotnet/core/install/linux">å‚è€ƒ</a></strong></p>

<h4 id="2æœåŠ¡èµ„æºåˆ†é…">2ã€æœåŠ¡èµ„æºåˆ†é…#</h4>

<p><strong>å› ä¸ºåªæœ‰ä¸€å°æœåŠ¡å™¨ï¼Œç”¨nginxè¿›è¡Œè½¬å‘ï¼šReactå‰ç«¯ç«¯å£80ï¼ŒIdentityServer4ç«¯å£5000ï¼ŒWebApièµ„æºç«¯å£8000ï¼ŒMvcç½‘ç«™ç«¯å£9000</strong><br />
 https://img2022.cnblogs.com/blog/1780813/202205/1780813-20220530144333924-463697186.png<strong>å¯åŠ¨å‘½ä»¤åˆ†ä¸¤æ­¥ï¼Œä¸¾ä¸ªæ —å­ï¼š</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /æŒ‡å®šç›®å½•
nohup dotnet ./BKYL.WEB.API.dll &amp;
</code></pre></div></div>

<h4 id="3nginxé…ç½®https">3ã€nginxé…ç½®https#</h4>

<p><strong>å› ä¸ºå…¨éƒ¨ä½¿ç”¨äº†httpsï¼Œæ‰€æœ‰åŸŸåã€äºŒçº§åŸŸåéƒ½æäº†sslè¯ä¹¦ï¼Œä¸€ä¸€å¯¹åº”ï¼Œé€šè¿‡ nginx é…ç½®éƒ¨ç½²ï¼Œè´´ä¸Šnginx.confå…³é”®éƒ¨åˆ†ä»¥ä¾›å‚è€ƒã€‚</strong></p>

<blockquote>
  <p>å¦‚ä½•è®¾ç½®äºŒçº§åŸŸåã€ç”³è¯·sslè¯ä¹¦ã€nginxé…ç½®sslè¯ä¹¦ï¼Œç½‘ä¸Šèµ„æ–™å¾ˆå¤šï¼Œä¸å†èµ˜è¿°ï¼Œæœ‰éœ€è¦çš„å¯ä»¥ç§</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
  listen       80;
  server_name  *.wintersir.com;
  
  rewrite ^(.*)$ https://$host$1;
  #charset koi8-r;
  error_page   500 502 503 504  /50x.html;
  location = /50x.html {
      root   html;
  }     
}
 
server {
  listen       443 ssl;
  server_name  www.wintersir.com wintersir.com;
  ssl_certificate      /app/nginx/conf/index/cert.pem;
  ssl_certificate_key  /app/nginx/conf/index/cert.key;
  ssl_session_cache    shared:SSL:1m;
  ssl_session_timeout  5m;
  ssl_ciphers  HIGH:!aNULL:!MD5;
  ssl_prefer_server_ciphers  on;
  location / {
    root   /app/wintersir/index;
    index  index.html index.htm;
  }
}

server {
  listen       443 ssl;
  server_name  homejok.wintersir.com;
  ssl_certificate      /app/nginx/conf/view/cert.pem;
  ssl_certificate_key  /app/nginx/conf/view/cert.key;
  ssl_session_cache    shared:SSL:1m;
  ssl_session_timeout  5m;
  ssl_ciphers  HIGH:!aNULL:!MD5;
  ssl_prefer_server_ciphers  on;
  location / {
  
    proxy_set_header X-Forearded-Proto $scheme;
    proxy_set_header Host $http_host;		
    proxy_set_header X-Real-IP $remote_addr;		
    
    add_header 'Access-Control-Allow-Origin' "$http_origin";		
    add_header 'Access-Control-Allow-Credentials' 'true';		
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';		
    add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken,Keep-Alive,X-Requested-With,If-Modified-Since,Content-Type';
  
    root   /app/wintersir/view;
    index  index.html index.htm;
  }
  
  location /api/ {
  
    proxy_set_header X-Forearded-Proto $scheme;
    proxy_set_header Host $http_host;		
    proxy_set_header X-Real-IP $remote_addr;		
    
    add_header 'Access-Control-Allow-Origin' "$http_origin";		
    add_header 'Access-Control-Allow-Credentials' 'true';		
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';		
    add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken,Keep-Alive,X-Requested-With,If-Modified-Since,Content-Type';
    proxy_pass https://www.wintersir.com:8000;
  }
}
 
server {
  listen       443 ssl;
  server_name  mvc.wintersir.com;
  ssl_certificate      /app/nginx/conf/mvc/cert.pem;
  ssl_certificate_key  /app/nginx/conf/mvc/cert.key;
  ssl_session_cache    shared:SSL:1m;
  ssl_session_timeout  5m;
  ssl_ciphers  HIGH:!aNULL:!MD5;
  ssl_prefer_server_ciphers  on;
  location / {
    proxy_set_header X-Forearded-Proto $scheme;
    proxy_set_header Host $http_host;		
    proxy_set_header X-Real-IP $remote_addr;		
    add_header 'Access-Control-Allow-Origin' "$http_origin";		
    add_header 'Access-Control-Allow-Credentials' 'true';		
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';		
    add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken,Keep-Alive,X-Requested-With,If-Modified-Since,Content-Type';
    proxy_pass https://www.wintersir.com:9000/;
  }
}

server {
  isten       443 ssl;
  server_name  login.wintersir.com;
 
  ssl_certificate      /app/nginx/conf/login/cert.pem;
  ssl_certificate_key  /app/nginx/conf/login/cert.key;
 
  ssl_session_cache    shared:SSL:1m;
  ssl_session_timeout  5m;
 
  ssl_ciphers  HIGH:!aNULL:!MD5;
  ssl_prefer_server_ciphers  on;
 
  location / {
  
    if ($request_method = 'OPTIONS') { 
       add_header 'Access-Control-Allow-Origin' "$http_origin";
       add_header 'Access-Control-Allow-Credentials' 'true';
       add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
       add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken,Keep-Alive,X-Requested-With,If-Modified-Since,Content-Type';
       return 200; 
    }
  
    proxy_set_header X-Forearded-Proto $scheme;
    proxy_set_header Host $http_host;		
    proxy_set_header X-Real-IP $remote_addr;		
    add_header 'Access-Control-Allow-Origin' "$http_origin";		
    add_header 'Access-Control-Allow-Credentials' 'true';		
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';		
    add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken,Keep-Alive,X-Requested-With,If-Modified-Since,Content-Type';
    proxy_pass https://www.wintersir.com:5000/;
  }
}
</code></pre></div></div>

<h2 id="å…­æ•ˆæœå›¾">å…­ã€æ•ˆæœå›¾#</h2>

<h4 id="1reactå‰ç«¯">1ã€Reactå‰ç«¯#</h4>

<p>https://img2022.cnblogs.com/blog/1780813/202205/1780813-20220530143323826-348525557.gif</p>

<h4 id="2mvcç½‘ç«™æµ‹è¯•">2ã€Mvcç½‘ç«™æµ‹è¯•#</h4>

<p>https://img2022.cnblogs.com/blog/1780813/202205/1780813-20220530143329034-2012384505.gif</p>

<h2 id="ä¸ƒå„ç§è¸©å‘">ä¸ƒã€å„ç§è¸©å‘#</h2>

<h4 id="1centos8ä¸æ”¯æŒ-net6">1ã€CentOS8ä¸æ”¯æŒ .NET6#</h4>

<p><strong>å½“åˆé˜¿é‡Œäº‘è£…äº†CentOS8ï¼Œç°åœ¨æƒ³å“­ï¼Œè¾¹å“­è¾¹è£…CentOS7.9ï¼ŒæŠŠæ•°æ®åº“ã€nginxç­‰ç¯å¢ƒåˆéƒ½è£…ä¸€éï¼ˆå‰å‡ ç¯‡éƒ½æœ‰ï¼‰ğŸ˜‚</strong><br />
 <strong>CentOS7 å®‰è£… .NET6 <a href="https://docs.microsoft.com/zh-cn/dotnet/core/install/linux-centos">å®˜æ–¹æ•™ç¨‹</a> ï¼Œåˆ†åˆ«æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œä¸­é—´è¾“å…¥äº†ä¸¤æ¬¡y</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo rpm -Uvh https://packages.microsoft.com/config/centos/7/packages-microsoft-prod.rpm
sudo yum install dotnet-sdk-6.0
</code></pre></div></div>

<h4 id="2nginxä¼ è¾“æ•°æ®è¿‡å¤§è½¬å‘è·¨åŸŸ">2ã€nginxä¼ è¾“æ•°æ®è¿‡å¤§ã€è½¬å‘è·¨åŸŸ#</h4>

<p><strong>ç®€å•æ¨¡å¼ token ç­‰ä¿¡æ¯å¸¦åœ¨äº†å›è°ƒé¡µé¢urlé‡Œï¼Œnginx 502 æ— æ³•è·³è½¬ï¼Œè§£å†³<a href="https://stackoverflow.com/questions/48964429/net-core-behind-nginx-returns-502-bad-gateway-after-authentication-by-identitys">å‚è€ƒ</a>ï¼Œnginx http æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š</strong><br />
 https://img2022.cnblogs.com/blog/1780813/202204/1780813-20220427224436345-683266032.png</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>proxy_buffer_size   128k;
proxy_buffers   4 256k;
proxy_busy_buffers_size   256k;
large_client_header_buffers 4 16k;
</code></pre></div></div>

<p><strong>å¤„ç†proxy_passè½¬å‘ï¼š</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>proxy_set_header X-Forearded-Proto $scheme;
proxy_set_header Host $http_host;		
proxy_set_header X-Real-IP $remote_addr;
add_header 'Access-Control-Allow-Origin' "$http_origin";		
add_header 'Access-Control-Allow-Credentials' 'true';		
add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';		
add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken,Keep-Alive,X-Requested-With,If-Modified-Since,Content-Type';
</code></pre></div></div>

<p><strong>å¤„ç†OPTIONSé¢„æ£€</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if ($request_method = 'OPTIONS') { 
  add_header 'Access-Control-Allow-Origin' "$http_origin";
  add_header 'Access-Control-Allow-Credentials' 'true';
  add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
  add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken,Keep-Alive,X-Requested-With,If-Modified-Since,Content-Type';
  return 200; 
}
</code></pre></div></div>

<h4 id="3jså®¢æˆ·ç«¯tokenä¼ è¾“æˆæƒ">3ã€jså®¢æˆ·ç«¯tokenä¼ è¾“ã€æˆæƒ#</h4>

<p><strong>jsï¼ˆreactã€vueç­‰ï¼‰å®¢æˆ·ç«¯éœ€è¦åœ¨æˆæƒæœåŠ¡é…ç½®æ—¶ï¼Œè®¾ç½®å…è®¸å°†tokené€šè¿‡æµè§ˆå™¨ä¼ é€’ AllowAccessTokensViaBrowser = trueï¼Œå®¢æˆ·ç«¯è®¾ç½®ç¦ç”¨äº†æˆæƒé¡µé¢ï¼Œç™»å½•é‰´æƒåç›´æ¥è·³å›å¯¹åº” RequireConsent = false</strong><br />
 https://img2022.cnblogs.com/blog/1780813/202204/1780813-20220428093759500-353565832.png</p>

<h4 id="4å‰ç«¯ç»Ÿä¸€æ¥å£è¿”å›æ ¼å¼">4ã€å‰ç«¯ç»Ÿä¸€æ¥å£è¿”å›æ ¼å¼#</h4>

<p><strong>Umiæ¡†æ¶é»˜è®¤æ ¼å¼ä¸åå°æ¥å£è¿”å›ä¸ä¸€è‡´å°±ä¼šå¯¼è‡´è·å–ä¸åˆ°ï¼Œconfig.ts åŠ ä¸Šä»¥ä¸‹ä»£ç ï¼Œå°±å¯ä»¥ä½¿ç”¨åå°è‡ªå®šä¹‰è¿”å›çš„æ•°æ®æ ¼å¼äº†</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>request: {
    dataField: ""  //å¿½ç•¥æ¡†æ¶å¤„ç†
}
</code></pre></div></div>

<h4 id="5postlogoutredirecturisæ— æ•ˆ">5ã€PostLogoutRedirectUrisæ— æ•ˆ#</h4>

<p><strong>æœ¬ä»¥ä¸ºé…ç½®äº†é€€å‡ºè·³è½¬è·¯ç”±å°±OKäº†ï¼Œç»“æœè¿˜æ˜¯å¾—è‡ªå·±åŠ ä»£ç æ‰‹åŠ¨è·³è½¬ï¼Œåœ¨æˆæƒæœåŠ¡ä¸­AccountControllerï¼ŒLogoutæ–¹æ³•</strong><br />
 https://img2022.cnblogs.com/blog/1780813/202205/1780813-20220528221038792-482411485.png</p>

<h4 id="6efcoreè¿æ¥æ•°æ®åº“å¶å°”å¼‚å¸¸an-exception-has-been-raised-that-is-likely-due-to-a-transient-failure">6ã€EFCoreè¿æ¥æ•°æ®åº“å¶å°”å¼‚å¸¸ï¼šAn exception has been raised that is likely due to a transient failure.#</h4>

<p><strong>æŸ¥èµ„æ–™è¯´æ˜¯sslé—®é¢˜ï¼Œè¿æ¥å­—ç¬¦ä¸²serveræ”¹æˆhttpsçš„ï¼Œä¸å¤ªç¡®å®šï¼Œå¤§ä½¬æ‡‚çš„å¯ä»¥è¯´ä¸€ä¸‹</strong></p>

<h2 id="å…«å‰äººæ ½æ ‘åäººä¹˜å‡‰">å…«ã€å‰äººæ ½æ ‘ï¼Œåäººä¹˜å‡‰#</h2>

<p><a href="https://github.com/skoruba/react-oidc-client-js">https://github.com/skoruba/react-oidc-client-js</a></p>

<h2 id="ä¹ä»£ç å·²ä¸Šä¼ ">ä¹ã€ä»£ç å·²ä¸Šä¼ #</h2>

<p><a href="https://github.com/wintersir">https://github.com/wintersir</a></p>

<h2 id="ååç»­">åã€åç»­#</h2>

<p><strong>åé¢å­¦ä¹ è¦å¾€å®¹å™¨ã€å¾®æœåŠ¡æ–¹å‘èµ°äº†ï¼ŒDockerã€Jenkinsã€DDD ç­‰ç­‰ï¼Œæƒ³å­¦å“ªä¸ªå­¦å“ªä¸ªï¼Œå†™äº†ä¹Ÿä¸ä¸€å®šå­¦ï¼Œå“ˆå“ˆ~~~ï¼Œè¿˜æ˜¯é‚£å¥è¯ï¼š</strong></p>

<h2 id="å†™åœ¨æœ€å">å†™åœ¨æœ€å#</h2>

<p><strong>åšå®¢åï¼šWinterSirï¼Œ<a href="https://www.cnblogs.com/WinterSir/p/13942849.html">å­¦ä¹ ç›®å½• https://www.cnblogs.com/WinterSir/p/13942849.html</a></strong></p>
<blockquote>
  <p>ä½œè€…:å†¬å…ˆç”Ÿ<br />
åŸæ–‡:https://www.cnblogs.com/WinterSir/p/16147929.html</p>
</blockquote>

  </div><a class="u-url" href="/cnblog/2022/05/31/%E5%8D%81%E4%BA%8C.NET6React%E5%8D%87%E7%BA%A7%E5%8D%87%E7%BA%A7%E8%BF%98%E6%98%AF%E5%8D%87%E7%BA%A7IdentityServer4%E5%AE%9E%E6%88%98.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">dotnetä¹‹ç¾</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">dotnetä¹‹ç¾</li><li><a class="u-email" href="mailto:springhgui@outlook.com">springhgui@outlook.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>åˆ†äº«dotnetæŠ€æœ¯.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
