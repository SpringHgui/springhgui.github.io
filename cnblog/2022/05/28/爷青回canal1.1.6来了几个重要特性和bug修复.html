<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>爷青回，canal 1.1.6来了，几个重要特性和bug修复 | dotnet之美</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="爷青回，canal 1.1.6来了，几个重要特性和bug修复" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="刚刚在群里看到消息说，时隔一年，canal 1.1.6正式release了，赶紧上去看看有什么新特性。" />
<meta property="og:description" content="刚刚在群里看到消息说，时隔一年，canal 1.1.6正式release了，赶紧上去看看有什么新特性。" />
<link rel="canonical" href="/cnblog/2022/05/28/%E7%88%B7%E9%9D%92%E5%9B%9Ecanal1.1.6%E6%9D%A5%E4%BA%86%E5%87%A0%E4%B8%AA%E9%87%8D%E8%A6%81%E7%89%B9%E6%80%A7%E5%92%8Cbug%E4%BF%AE%E5%A4%8D.html" />
<meta property="og:url" content="/cnblog/2022/05/28/%E7%88%B7%E9%9D%92%E5%9B%9Ecanal1.1.6%E6%9D%A5%E4%BA%86%E5%87%A0%E4%B8%AA%E9%87%8D%E8%A6%81%E7%89%B9%E6%80%A7%E5%92%8Cbug%E4%BF%AE%E5%A4%8D.html" />
<meta property="og:site_name" content="dotnet之美" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-05-28T16:00:31+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="爷青回，canal 1.1.6来了，几个重要特性和bug修复" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-05-28T16:00:31+00:00","datePublished":"2022-05-28T16:00:31+00:00","description":"刚刚在群里看到消息说，时隔一年，canal 1.1.6正式release了，赶紧上去看看有什么新特性。","headline":"爷青回，canal 1.1.6来了，几个重要特性和bug修复","mainEntityOfPage":{"@type":"WebPage","@id":"/cnblog/2022/05/28/%E7%88%B7%E9%9D%92%E5%9B%9Ecanal1.1.6%E6%9D%A5%E4%BA%86%E5%87%A0%E4%B8%AA%E9%87%8D%E8%A6%81%E7%89%B9%E6%80%A7%E5%92%8Cbug%E4%BF%AE%E5%A4%8D.html"},"url":"/cnblog/2022/05/28/%E7%88%B7%E9%9D%92%E5%9B%9Ecanal1.1.6%E6%9D%A5%E4%BA%86%E5%87%A0%E4%B8%AA%E9%87%8D%E8%A6%81%E7%89%B9%E6%80%A7%E5%92%8Cbug%E4%BF%AE%E5%A4%8D.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="dotnet之美" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">dotnet之美</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">爷青回，canal 1.1.6来了，几个重要特性和bug修复</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2022-05-28T16:00:31+00:00" itemprop="datePublished">May 28, 2022
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>刚刚在群里看到消息说，时隔一年，canal 1.1.6正式release了，赶紧上去看看有什么新特性。</p>

<p><img src="https://p26.toutiaoimg.com/origin/tos-cn-i-qvj2lq49k0/7c21588f0810475c86754e65cb061808?from=pc" alt="爷青回，canal 1.1.6来了，几个重要特性和bug修复" /></p>

<p>（居然才发布了6个小时，前排围观）</p>

<h1 id="1什么是canal">1、什么是canal</h1>

<p>canal [kə’næl]，译意为水道/管道/沟渠，主要用途是基于 MySQL 数据库增量日志解析，提供增量数据 订阅 和 消费。应该是阿里云DTS（Data Transfer Service）的开源版本。</p>

<p>如果想了解更多，可以上github上看官方文档，或者我之前写过的系列基于canal 1.1.4版本的入门文档。</p>

<h1 id="2重要新特性">2、重要新特性</h1>

<p>我们现在生产用的还是1.1.4版本，用得还算稳定，没有什么特别大的bug。</p>

<p>这次，趁着升级了两个版本，看看1.1.5和1.1.6版本有什么新特性可以值得升级引入。</p>

<h1 id="21-mq发送优化">2.1 MQ发送优化</h1>

<blockquote>
  <p>重点优化MQ发送的性能，单topic最高峰值可支持3~8万的rps，接近数量级上的性能提升</p>
</blockquote>

<p>这是1.1.5中的重要特性优化。</p>

<p>为什么canal需要搭配MQ使用，甚至重点优化MQ的投递性能呢？</p>

<p>主要原因是 canal + MQ 可以打造强大的异构存储体系。</p>

<p><img src="https://p26.toutiaoimg.com/origin/tos-cn-i-qvj2lq49k0/6e15b818b9254dc1b900be7360891a7b?from=pc" alt="爷青回，canal 1.1.6来了，几个重要特性和bug修复" /></p>

<p>canal订阅binlog后有两种模式，一种是直接投递到一种介质，如mysql，一种是投递到MQ然后自定义消费。</p>

<p>如果采用投递到MQ的模式，那么我们就可以利用MQ进行一份消息多端消费（避免重复拉取binlog对MySQL造成影响），用于构建二级索引ES或者构建缓存Redis等等。</p>

<p>另一方面，投递mq以后，对于消息的回溯、监控都能提供更好的途径。</p>

<p>总的来说，canal这个特性优化给 canal + MQ 的模式带来了更加强大的支持。</p>

<h1 id="22-mq发送特性支持">2.2 MQ发送特性支持</h1>

<blockquote>
  <p>新增rabbitmQ的MQ发送支持 #2156<br />
支持不同topic设置不同的分区数 #2173<br />
rocketMQ新增tag属性的定义 #3438<br />
参数配置支持env环境变量 #3450</p>
</blockquote>

<p>这是1.1.5中的一个小优化，但是我觉得非常重要。</p>

<p>比如rocketMQ新增tag属性的定义。实际上在我们的测试环境，就非常需要这个特性。</p>

<p>我们使用rocketMQ的tag做路由，如果业务方自行生产和消费，可以完全根据tag进行路由区分。而从canal订阅的数据库变更，1.1.4版本无法直接给消息打tag，业务消费就无法通过tag进行路由。</p>

<p>现在这个特性的优化，正好可以解决这个问题。</p>

<h1 id="23-新增puslar-mq支持">2.3 新增Puslar MQ支持</h1>

<p>这是1.1.6中的一个小优化，还是非常与时俱进的。</p>

<p>目前的云原生消息队列Puslar MQ，凭借存储和计算分离的架构在云原生体系下如日中天，而canal就在最新版本支持了对Puslar MQ的投递，手动点赞。</p>

<h1 id="3重要bug修复">3、重要bug修复</h1>

<h1 id="31-修复gtid模式下位点持久不更新的问题">3.1 修复gtid模式下位点持久不更新的问题</h1>

<p>这是1.1.5中修复的bug。</p>

<p>GTID又叫全局事务ID（Global Transaction ID），是一个已提交事务的编号，并且是一个全局唯一的编号。MySQL5.6版本之后在主从复制类型上新增了GTID复制。</p>

<p>为什么要引入这个东西呢？</p>

<ul>
  <li>GTID使用master_auto_position=1代替了基于binlog和position号的主从复制搭建方式，更便于主从复制的搭建。</li>
  <li>GTID可以知道事务在最开始是在哪个实例上提交的。</li>
  <li>GTID方便实现主从之间的failover，再也不用不断地去找position和binlog 了。</li>
</ul>

<p>为什么我特别关注到这个bug的修复呢？</p>

<p>因为我在2020年对canal 1.1.4进行poc的时候，就发现这个bug了，当时还吐槽了一波，233333。</p>

<p><img src="https://p26.toutiaoimg.com/origin/tos-cn-i-qvj2lq49k0/195f015d5a984d68b3e94b8ac0a48069?from=pc" alt="爷青回，canal 1.1.6来了，几个重要特性和bug修复" /></p>

<p>一晃两年过去了，没想到在1.1.5中已经修复了，手动点赞。</p>

<h1 id="32-修复rdb同步下的关键字引起的同步报错">3.2 修复RDB同步下的关键字引起的同步报错</h1>

<p>这是1.1.6中修复的bug。</p>

<p>对于这个bug，也是有点记忆犹新。</p>

<p>当时在莫干山度假，突然早上八点收到线上警报，发现数据同步出现异常。</p>

<p>好在随身带了电脑（程序员出远门必备，sigh~），经过排查后发现，就是一个表结构变更引入的关键字导致了同步异常。</p>

<p>往事不堪回首。。。</p>

<h1 id="4总结">4、总结</h1>

<p>这里简单介绍了几个对我们生产中比较重要的优化和修复，具体更多内容大家可以直接去github上看release note。</p>

<p>总的来说，1.1.5和1.1.6都做了非常多的bug修复和特性优化，还是非常值得升级的。</p>

<blockquote>
  <p>都看到最后了，原创不易，点个关注，点个赞吧～</p>
</blockquote>

<blockquote>
  <p>文章持续更新，可以微信搜索「阿丸笔记 」第一时间阅读，回复【笔记】获取Canal、MySQL、HBase、JAVA实战笔记，回复【资料】获取一线大厂面试资料。</p>
</blockquote>

<blockquote>
  <p>知识碎片重新梳理，构建Java知识图谱：<a href="https://github.com/saigu/JavaKnowledgeGraph">github.com/saigu/JavaK…</a>（历史文章查阅非常方便）
作者:阿丸<br />
原文:https://www.cnblogs.com/awan-note/p/16316503.html</p>
</blockquote>

  </div><a class="u-url" href="/cnblog/2022/05/28/%E7%88%B7%E9%9D%92%E5%9B%9Ecanal1.1.6%E6%9D%A5%E4%BA%86%E5%87%A0%E4%B8%AA%E9%87%8D%E8%A6%81%E7%89%B9%E6%80%A7%E5%92%8Cbug%E4%BF%AE%E5%A4%8D.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">dotnet之美</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">dotnet之美</li><li><a class="u-email" href="mailto:springhgui@outlook.com">springhgui@outlook.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>分享dotnet技术.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
